<div class="dh-adv-manager-content preview-container">
    
    <!-- Top Control: Actor Selection & Filter -->
    <div class="preview-controls form-group">
        <div class="actor-selection-row">
            
            <div class="select-wrapper source-wrapper">
                <select name="source" class="source-select">
                    {{#each sourceOptions}}
                    <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                    {{/each}}
                </select>
                <i class="fas fa-database select-arrow"></i>
            </div>

            <button type="button" data-action="openSettings" class="settings-btn" title="Manage Compendiums">
                <i class="fas fa-cog"></i>
            </button>

            <div class="select-wrapper filter-wrapper small-filter">
                <select name="filterTier" class="filter-tier-select">
                    {{#each filterOptions}}
                    <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                    {{/each}}
                </select>
                <i class="fas fa-filter select-arrow"></i>
            </div>

            <div class="select-wrapper filter-wrapper small-filter">
                <select name="filterType" class="filter-type-select">
                    {{#each typeOptions}}
                    <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                    {{/each}}
                </select>
                <i class="fas fa-paw select-arrow"></i>
            </div>

            <div class="select-wrapper actor-wrapper">
                <select name="actorSelect" class="main-actor-select">
                    <option value="" disabled {{#unless selectedActorId}}selected{{/unless}}>-- Choose an Adversary --</option>
                    {{#each adversaries}}
                    <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.name}}</option>
                    {{/each}}
                </select>
                <i class="fas fa-chevron-down select-arrow"></i>
            </div>

            <button type="button" data-action="openStats" class="settings-btn" title="Compendium Stats">
                <i class="fas fa-chart-pie"></i>
            </button>

            <button type="button" data-action="openDiceProb" class="settings-btn" title="Dice Probability">
                <i class="fas fa-dice-d20"></i>
            </button>
        </div>
    </div>

    {{#if hasActor}}
    
    <!-- Tier Selection Tabs -->
    <div class="tier-tabs">
        <div class="tier-control-row">
            <label style="white-space: nowrap; margin-right: 5px; font-weight: bold; color: #aaa;">Target Tier:</label>
            <div class="tier-buttons" style="margin-top: 0; flex: 1;">
                {{#each tiers}}
                <button type="button" 
                        class="tier-tab-btn {{this.cssClass}}" 
                        data-action="selectTier" 
                        data-tier="{{this.value}}">
                    {{this.label}}
                </button>
                {{/each}}
            </div>
        </div>
    </div>

    <!-- Split View Body -->
    <div class="preview-body">
        
        <!-- Left Column: Current State -->
        <div class="preview-column current-column" style="justify-content: flex-start;">
            <h3 class="col-header">
                Current (T{{currentStats.tier}})
                {{#if linkData}}
                    <i class="fas {{linkData.icon}} {{linkData.cssClass}}" title="{{linkData.label}}" style="font-size: 0.7em; vertical-align: middle; margin-left: 5px;"></i>
                {{/if}}
            </h3>
            
            <div class="stat-row">
                <span class="stat-label">Difficulty</span>
                <span class="stat-value">
                    {{#if currentStats.hitChanceAgainst}}
                        <span style="color: #aaa; font-size: 1em; margin-right: 5px; cursor: help;" title="{{currentStats.hitChanceAgainst.tooltip}}">{{currentStats.hitChanceAgainst.text}}</span>
                    {{/if}}
                    {{currentStats.difficulty}}
                </span>
            </div>

            <!-- HP & STRESS ROW (CURRENT) -->
            <div class="stat-row-dual">
                <div class="stat-col-half">
                    <span class="stat-label">HP</span>
                    <span class="stat-value">{{currentStats.hp}}</span>
                </div>
                <div class="stat-separator"></div> <!-- Separator Added -->
                <div class="stat-col-half">
                    <span class="stat-label">Stress</span>
                    <span class="stat-value">{{currentStats.stress}}</span>
                </div>
            </div>

            <div class="stat-row">
                <span class="stat-label">Thresholds</span>
                <span class="stat-value">{{currentStats.thresholds}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Attack Bonus</span>
                <span class="stat-value">
                    {{#if currentStats.hitChance}}
                        <span style="color: #aaa; font-size: 1em; margin-right: 5px; cursor: help;" title="{{currentStats.hitChance.tooltip}}">{{currentStats.hitChance.text}}</span>
                    {{/if}}
                    {{currentStats.attackMod}}
                </span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Critical Threshold</span>
                <span class="stat-value">{{currentStats.critical}}</span>
            </div>

            <div class="stat-group">
                <span class="stat-label">
                    Attack Damage 
                    {{#if currentStats.damageTypesLabel}}
                        <!-- Using current-hint-text class as requested -->
                        <span class="current-hint-text">{{currentStats.damageTypesLabel}}</span>
                    {{/if}}
                </span>
                <!-- Stats moved to use current-hint-text -->
                <div class="stat-block">{{currentStats.damage}} <span class="current-hint-text">{{currentStats.damageStats}}</span></div>
            </div>
            
            {{#if isHorde}}
                {{#if currentStats.halvedDamage}}
                <div class="stat-group">
                    <span class="stat-label">Halved Damage (Horde)</span>
                    <!-- Stats moved to use current-hint-text -->
                    <div class="stat-block">{{currentStats.halvedDamage}} <span class="current-hint-text">{{currentStats.halvedDamageStats}}</span></div>
                </div>
                {{/if}}
            {{/if}}

            {{#if currentStats.experiences.length}}
                <div class="stat-group">
                    <span class="stat-label">Experiences</span>
                    <div class="stat-block" style="height: auto; white-space: normal;">
                        {{#each currentStats.experiences}}
                            {{this.name}} {{this.value}}{{#unless @last}}, {{/unless}}
                        {{/each}}
                    </div>
                </div>
            {{/if}}
            
            <div class="actor-preview-name" style="margin-top: 15px;">
                {{actorName}} ({{actorTypeLabel}})
            </div>

            {{#if portraitImg}}
            <div class="portrait-display-wrapper">
                <div class="portrait-display" data-action="openSheet">
                    <img src="{{portraitImg}}" alt="{{actorName}}" class="actor-portrait">
                </div>
            </div>
            <div class="preview-note" style="margin-top: 5px;">
                <i class="fas fa-external-link-alt"></i> Click image to open sheet
            </div>
            {{/if}}

        </div>

        <!-- Right Column: Preview State -->
        <div class="preview-column future-column">
            <h3 class="col-header future-header">Preview (T{{previewStats.tier}})</h3>
            
            {{#if previewStats.error}}
                <div class="error-msg">{{previewStats.error}}</div>
            {{else}}
                
                <div class="stat-row">
                    <span class="stat-label">Difficulty</span>
                    <div class="stat-input-group">
                        <span class="stat-value-hint">
                            {{#if previewStats.hitChanceAgainst}}
                                <span style="color: #ea80fc; margin-right: 5px; cursor: help;" title="{{previewStats.hitChanceAgainst.tooltip}}">{{previewStats.hitChanceAgainst.text}}</span>
                            {{/if}}
                            {{{previewStats.difficultyDisplay}}}
                        </span>
                        <input type="number" class="override-input" data-field="difficulty" value="{{previewStats.difficulty}}" title="Manual Override">
                    </div>
                </div>
                
                <!-- HP & STRESS ROW (PREVIEW) -->
                <div class="stat-row-dual">
                    <div class="stat-col-half">
                        <span class="stat-label">HP</span>
                        <div class="stat-input-group dual-compact">
                            <span class="stat-value-hint">{{{previewStats.hpDisplay}}}</span>
                            <input type="number" class="override-input" data-field="hp" value="{{previewStats.hp}}" title="Manual Override" {{#if previewStats.isMinion}}disabled{{/if}}>
                        </div>
                    </div>
                    <div class="stat-separator"></div> <!-- Separator Added -->
                    <div class="stat-col-half">
                        <span class="stat-label">Stress</span>
                        <div class="stat-input-group dual-compact">
                            <span class="stat-value-hint">{{{previewStats.stressDisplay}}}</span>
                            <input type="number" class="override-input" data-field="stress" value="{{previewStats.stress}}" title="Manual Override">
                        </div>
                    </div>
                </div>

                <div class="stat-row">
                    <span class="stat-label">Thresholds</span>
                    <div class="stat-input-group dual-input">
                        <span class="stat-value-hint">{{{previewStats.thresholdsDisplay}}}</span>
                        {{#if previewStats.isMinion}}
                        {{else}}
                            <input type="number" class="override-input small" data-field="major" value="{{previewStats.major}}" placeholder="Maj" title="Major">
                            /
                            <input type="number" class="override-input small" data-field="severe" value="{{previewStats.severe}}" placeholder="Sev" title="Severe">
                        {{/if}}
                    </div>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">Attack Bonus</span>
                    <div class="stat-input-group">
                        <span class="stat-value-hint">
                            {{#if previewStats.hitChance}}
                                <span style="color: #ea80fc; margin-right: 5px; cursor: help;" title="{{previewStats.hitChance.tooltip}}">{{previewStats.hitChance.text}}</span>
                            {{/if}}
                            {{{previewStats.attackModDisplay}}}
                        </span>
                        <input type="number" class="override-input" data-field="attackMod" value="{{previewStats.attackMod}}" title="Manual Override">
                    </div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Critical Threshold</span>
                    <div class="stat-input-group">
                        <select class="override-input critical-select" style="width: 60px;">
                            {{#each criticalOptions}}
                            <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                            {{/each}}
                        </select>
                    </div>
                </div>

                <div class="stat-group">
                    <div style="display:flex; flex-wrap: wrap; justify-content:space-between; align-items:center;">
                        <span class="stat-label" style="display: flex; align-items: center; gap: 8px;">
                            Attack Damage
                            <div class="damage-type-controls">
                                <label title="Physical Damage"><input type="checkbox" class="damage-type-checkbox" value="physical" {{#if isPhysical}}checked{{/if}}> Physical</label>
                                <label title="Magical Damage"><input type="checkbox" class="damage-type-checkbox" value="magical" {{#if isMagical}}checked{{/if}}> Magical</label>
                            </div>
                        </span>
                        <div class="feature-input-group" style="width: 100%; max-width: 150px;">
                            <i class="fas fa-question-circle suggestion-icon" data-tooltip="{{{damageTooltip}}}"></i>
                            <input type="text" class="override-input" data-field="damageFormula" value="{{previewStats.mainDamageFormula}}" style="text-align: right; width: 100%;">
                        </div>
                    </div>
                    <!-- Stats moved to use preview-hint-text -->
                    <div class="stat-block inverted-colors">{{{previewStats.damage}}} <span class="preview-hint-text">{{previewStats.damageStats}}</span></div>
                </div>

                {{#if previewStats.halvedDamage}}
                <div class="stat-group">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="stat-label">Halved Damage (Horde)</span>
                        <div class="feature-input-group" style="width: 100%; max-width: 150px;">
                            <i class="fas fa-question-circle suggestion-icon" data-tooltip="{{{halvedDamageTooltip}}}"></i>
                            <input type="text" class="override-input" data-field="halvedDamageFormula" value="{{previewStats.mainHalvedDamageFormula}}" style="text-align: right; width: 100%;">
                        </div>
                    </div>
                    <!-- Stats moved to use preview-hint-text -->
                    <div class="stat-block inverted-colors">{{{previewStats.halvedDamage}}} <span class="preview-hint-text">{{previewStats.halvedDamageStats}}</span></div>
                </div>
                {{/if}}
                
                <div class="preview-note" style="margin: 15px 0 10px 0;">
                    <i class="fas fa-info-circle"></i> Edit values to override random rolls.
                </div>

                <!-- PREVIEW EXPERIENCES -->
                <div class="stat-group">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="stat-label">
                            Experiences
                            <i class="fas fa-question-circle suggestion-icon" data-tooltip="{{{previewStats.expTooltip}}}"></i>
                        </span>
                        <button type="button" data-action="addExperience" class="add-btn-small" title="Add Experience"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="stat-block-list experiences-list">
                        {{#each previewStats.experiences}}
                            <div class="exp-item-preview {{#if this.isNew}}exp-new{{/if}}" style="display: flex; align-items: center; gap: 5px; margin-bottom: 4px;">
                                <input type="text" class="exp-name-input" data-id="{{this.id}}" value="{{this.name}}" placeholder="Exp Name" style="flex: 1; min-width: 0;">
                                
                                <button type="button" data-action="rollExperienceName" data-id="{{this.id}}" class="roll-btn-small" title="Roll Random Name" style="flex: 0 0 28px; height: 28px; border: 1px solid #555; background: #333; color: #ea80fc; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px;">
                                    <i class="fas fa-dice"></i>
                                </button>

                                <select class="exp-mod-select" data-id="{{this.id}}" style="flex: 0 0 60px;">
                                    {{#each this.options}}
                                        <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                                    {{/each}}
                                </select>
                                <button type="button" data-action="deleteExperience" data-id="{{this.id}}" class="delete-btn-small" title="Remove" style="flex: 0 0 24px; color: #ff6b6b; background: none; border: none; cursor: pointer;"><i class="fas fa-trash"></i></button>
                            </div>
                        {{/each}}
                    </div>
                </div>

                <!-- FEATURES SECTION -->
                <div class="features-preview-section">
                    <h4 class="features-header">Feature Changes</h4>
                    {{#if featurePreviewData.length}}
                        <div class="feature-changes-list">
                            {{#each featurePreviewData}}
                                <div class="feature-change-row" style="display: flex; justify-content: space-between; align-items: center; gap: 5px;">
                                    <div class="feature-label" style="flex: 1; min-width: 0; display: flex; align-items: center; gap: 5px;">
                                        {{#if this.img}}
                                            <a class="feature-icon-link" data-action="openFeature" data-uuid="{{this.uuid}}" title="Open Item" style="flex-shrink: 0;">
                                                <img src="{{this.img}}" style="width: 24px; height: 24px; border: none; vertical-align: middle;">
                                            </a>
                                        {{/if}}
                                        <div style="overflow: hidden; text-overflow: ellipsis;">
                                            {{this.typeLabel}} 
                                            {{{this.originalName}}} <i class="fas fa-arrow-right" style="font-size: 0.8em; opacity: 0.5; margin: 0 5px;"></i>
                                        </div>
                                    </div>
                                    {{#if this.stats}}
                                        <div class="feature-stats">
                                            {{this.stats}}
                                        </div>
                                    {{/if}}
                                    <div class="feature-control" style="flex: 0 0 auto; display: flex; align-items: center; gap: 5px;">
                                        {{#if this.isHordeFeature}}
                                            <div class="feature-input-group" style="justify-content: flex-end;">
                                                <input type="text" class="feature-override-input" value="{{this.newName}}" disabled style="width: 80px; text-align: center; opacity: 0.7;">
                                            </div>
                                        {{else if this.options}}
                                            <div class="feature-input-group" style="display: flex; align-items: center; gap: 2px;">
                                                <i class="fas fa-question-circle suggestion-icon" data-tooltip="{{{this.optionsTooltip}}}"></i>
                                                
                                                <input type="text" class="feature-override-input feature-damage-input" 
                                                       data-itemid="{{this.itemId}}" 
                                                       data-original="{{this.originalFormula}}" 
                                                       value="{{this.newName}}" 
                                                       style="width: 80px;">
                                            </div>
                                        {{else if this.isMinionFeature}}
                                            <div class="minion-group" style="display:flex; align-items:center; gap:2px; font-weight:bold; color:#ea80fc;">
                                                Minion ( <input type="number" class="minion-val-input" data-itemid="{{this.itemId}}" value="{{this.minionValue}}"> )
                                            </div>
                                        {{else}}
                                            {{#if this.isRenamed}}
                                                <input type="text" class="feature-override-input" data-itemid="{{this.itemId}}" value="{{this.newName}}" title="Rename Feature">
                                            {{else}}
                                                <div class="feature-new-static">{{this.newName}}</div>
                                            {{/if}}
                                        {{/if}}
                                    </div>
                                </div>
                            {{/each}}
                        </div>
                    {{else}}
                        <div class="no-changes">No modified features.</div>
                    {{/if}}
                </div>

                <!-- NEW FEATURES SECTION -->
                {{#if allSuggestedFeatures.length}}
                <div class="features-preview-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 class="features-header" style="color: #98fb98; margin: 0;">New Features</h4>
                        <div class="feature-header-controls" style="width: 180px; display: flex; gap: 5px;">
                            <select class="suggestion-tier-select" style="font-size: 0.85em; height: 26px; width: 70px; background: rgba(0, 0, 0, 0.5); border: 1px solid #555; color: #ea80fc; border-radius: 3px;">
                                {{#each suggestedFeaturesTierOptions}}
                                    <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                                {{/each}}
                            </select>
                            <select class="suggestion-type-select" style="font-size: 0.85em; height: 26px; flex: 1; background: rgba(0, 0, 0, 0.5); border: 1px solid #555; color: #ea80fc; border-radius: 3px;">
                                {{#each suggestedFeaturesTypeOptions}}
                                    <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                    <div class="feature-changes-list">
                        {{#each allSuggestedFeatures}}
                            <div class="feature-change-row new-feature-row">
                                <label class="feature-label" style="cursor: pointer; display: flex; align-items: center; width: 100%;">
                                    <input type="checkbox" class="feature-checkbox" data-feature="{{this.name}}" {{#if this.checked}}checked{{/if}} style="margin-right: 8px; flex-shrink: 0;">
                                    <a class="feature-link" data-action="openFeature" data-uuid="{{this.uuid}}" style="flex: 1; display: flex; align-items: center;">
                                        {{#if this.img}}
                                            <img src="{{this.img}}" class="feature-icon-small" alt="{{this.name}}" style="flex-shrink: 0;">
                                        {{/if}}
                                        
                                        <strong style="color: #eee;">{{this.name}}</strong>

                                        {{#if this.tags.action.label}}
                                            <span class="dh-tag {{this.tags.action.css}}">{{this.tags.action.label}}</span>
                                        {{/if}}
                                        {{#if this.tags.tier}}
                                            <span class="dh-tag tag-tier">{{this.tags.tier}}</span>
                                        {{/if}}
                                        {{#if this.tags.type}}
                                            <span class="dh-tag tag-type">{{this.tags.type}}</span>
                                        {{/if}}
                                        {{#if this.tags.homebrew}}
                                            <span class="dh-tag tag-homebrew">{{this.tags.homebrew}}</span>
                                        {{/if}}

                                        {{#if this.isRuleSuggestion}}
                                            <i class="fas fa-star" title="Recommended" style="color: #ffd700; margin-left: auto; font-size: 0.8em;"></i>
                                        {{/if}}
                                    </a>
                                </label>
                            </div>
                        {{/each}}
                    </div>
                </div>
                {{/if}}
                
            {{/if}}
        </div>

    </div>

    <footer class="sheet-footer">
        <button type="button" data-action="applyChanges" class="apply-btn">
            {{#if (eq linkData null)}}
                <i class="fas fa-file-import"></i> Import & Apply Tier {{previewStats.tier}}
            {{else}}
                <i class="fas fa-bolt"></i> Apply Tier {{previewStats.tier}} to {{actorName}}
            {{/if}}
        </button>
    </footer>

    {{else}}
    <div class="empty-state">
        <i class="fas fa-skull" style="font-size: 4em; opacity: 0.3; margin-bottom: 20px;"></i>
        <p>Select an Adversary from the list above to begin preview.</p>
    </div>
    {{/if}}

</div>