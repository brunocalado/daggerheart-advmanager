<div class="dh-adv-manager-content preview-container">
    
    <!-- Top Control: Actor Selection & Filter -->
    <div class="preview-controls form-group">
        
        <div class="actor-selection-row">
            
            <!-- Source Selector -->
            <div class="select-wrapper source-wrapper">
                <select name="source" class="source-select">
                    {{#each sourceOptions}}
                    <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                    {{/each}}
                </select>
                <i class="fas fa-database select-arrow"></i>
            </div>

            <!-- Settings Button -->
            <button type="button" data-action="openSettings" class="settings-btn" title="Manage Compendiums">
                <i class="fas fa-cog"></i>
            </button>

            <!-- Filter by Tier -->
            <div class="select-wrapper filter-wrapper small-filter">
                <select name="filterTier" class="filter-tier-select">
                    {{#each filterOptions}}
                    <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                    {{/each}}
                </select>
                <i class="fas fa-filter select-arrow"></i>
            </div>

            <!-- Filter by Type -->
            <div class="select-wrapper filter-wrapper small-filter">
                <select name="filterType" class="filter-type-select">
                    {{#each typeOptions}}
                    <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                    {{/each}}
                </select>
                <i class="fas fa-paw select-arrow"></i>
            </div>

            <!-- Main Actor Selector -->
            <div class="select-wrapper actor-wrapper">
                <select name="actorSelect" class="main-actor-select">
                    <option value="" disabled {{#unless selectedActorId}}selected{{/unless}}>-- Choose an Adversary --</option>
                    {{#each adversaries}}
                    <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.name}}</option>
                    {{/each}}
                </select>
                <i class="fas fa-chevron-down select-arrow"></i>
            </div>

            <!-- Stats Button (NEW) -->
            <button type="button" data-action="openStats" class="settings-btn" title="Compendium Stats">
                <i class="fas fa-chart-pie"></i>
            </button>
        </div>
    </div>

    {{#if hasActor}}
    
    <!-- Tier Selection Tabs -->
    <div class="tier-tabs">
        <label>Target Tier:</label>
        <div class="tier-buttons">
            {{#each tiers}}
            <button type="button" 
                    class="tier-tab-btn {{this.cssClass}}" 
                    data-action="selectTier" 
                    data-tier="{{this.value}}">
                {{this.label}}
            </button>
            {{/each}}
        </div>
    </div>

    <!-- Split View Body -->
    <div class="preview-body">
        
        <!-- Left Column: Current State -->
        <div class="preview-column current-column">
            <h3 class="col-header">
                Current (T{{currentStats.tier}})
                {{#if linkData}}
                    <i class="fas {{linkData.icon}} {{linkData.cssClass}}" title="{{linkData.label}}" style="font-size: 0.7em; vertical-align: middle; margin-left: 5px;"></i>
                {{/if}}
            </h3>
            
            <div class="stat-row">
                <span class="stat-label">Difficulty</span>
                <span class="stat-value">
                    {{currentStats.difficulty}}
                    {{#if currentStats.hitChanceAgainst}}
                        <span style="font-size: 0.8em; color: #aaa; margin-left: 5px; cursor: help;" title="{{currentStats.hitChanceAgainst.tooltip}}">{{currentStats.hitChanceAgainst.text}}</span>
                    {{/if}}
                </span>
            </div>
            <div class="stat-row">
                <span class="stat-label">HP</span>
                <span class="stat-value">{{currentStats.hp}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Stress</span>
                <span class="stat-value">{{currentStats.stress}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Thresholds</span>
                <span class="stat-value">{{currentStats.thresholds}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Attack Bonus</span>
                <span class="stat-value">
                    {{currentStats.attackMod}}
                    {{#if currentStats.hitChance}}
                        <span style="font-size: 0.8em; color: #aaa; margin-left: 5px; cursor: help;" title="{{currentStats.hitChance.tooltip}}">{{currentStats.hitChance.text}}</span>
                    {{/if}}
                </span>
            </div>
            <div class="stat-group">
                <span class="stat-label">Attack Damage</span>
                <div class="stat-block">{{currentStats.damage}}</div>
            </div>
            
            {{#if currentStats.halvedDamage}}
            <div class="stat-group">
                <span class="stat-label">Halved Damage (Horde)</span>
                <div class="stat-block">{{currentStats.halvedDamage}}</div>
            </div>
            {{/if}}
            
            <!-- NEW: Actor Name Header -->
            <div class="actor-preview-name">
                {{actorName}}
            </div>

            <!-- PORTRAIT DISPLAY SECTION -->
            {{#if portraitImg}}
            <div class="portrait-display-wrapper">
                <div class="portrait-display">
                    <img src="{{portraitImg}}" alt="{{actorName}}" class="actor-portrait">
                </div>
            </div>
            {{/if}}

        </div>

        <!-- Right Column: Preview State -->
        <div class="preview-column future-column">
            <h3 class="col-header future-header">Preview (T{{previewStats.tier}})</h3>
            
            {{#if previewStats.error}}
                <div class="error-msg">{{previewStats.error}}</div>
            {{else}}
                <div class="stat-row">
                    <span class="stat-label">Difficulty</span>
                    <div class="stat-input-group">
                        <span class="stat-value-hint">
                            {{{previewStats.difficultyDisplay}}}
                            {{#if previewStats.hitChanceAgainst}}
                                <br><span style="font-size: 0.7em; color: #ea80fc; cursor: help;" title="{{previewStats.hitChanceAgainst.tooltip}}">{{previewStats.hitChanceAgainst.text}}</span>
                            {{/if}}
                        </span>
                        <input type="number" class="override-input" data-field="difficulty" value="{{previewStats.difficulty}}" title="Manual Override">
                    </div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">HP</span>
                    <div class="stat-input-group">
                        <span class="stat-value-hint">{{{previewStats.hpDisplay}}}</span>
                        <input type="number" class="override-input" data-field="hp" value="{{previewStats.hp}}" title="Manual Override" {{#if previewStats.isMinion}}disabled{{/if}}>
                    </div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Stress</span>
                    <div class="stat-input-group">
                        <span class="stat-value-hint">{{{previewStats.stressDisplay}}}</span>
                        <input type="number" class="override-input" data-field="stress" value="{{previewStats.stress}}" title="Manual Override">
                    </div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Thresholds</span>
                    <div class="stat-input-group dual-input">
                        <span class="stat-value-hint">{{{previewStats.thresholdsDisplay}}}</span>
                        {{#if previewStats.isMinion}}
                            <!-- Hidden or disabled -->
                        {{else}}
                            <input type="number" class="override-input small" data-field="major" value="{{previewStats.major}}" placeholder="Maj" title="Major">
                            /
                            <input type="number" class="override-input small" data-field="severe" value="{{previewStats.severe}}" placeholder="Sev" title="Severe">
                        {{/if}}
                    </div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Attack Bonus</span>
                    <div class="stat-input-group">
                        <span class="stat-value-hint">
                            {{{previewStats.attackModDisplay}}}
                            {{#if previewStats.hitChance}}
                                <br><span style="font-size: 0.7em; color: #ea80fc; cursor: help;" title="{{previewStats.hitChance.tooltip}}">{{previewStats.hitChance.text}}</span>
                            {{/if}}
                        </span>
                        <input type="number" class="override-input" data-field="attackMod" value="{{previewStats.attackMod}}" title="Manual Override">
                    </div>
                </div>
                <div class="stat-group">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="stat-label">Attack Damage</span>
                        <!-- REPLACED: Select with Input Group -->
                        <div class="feature-input-group" style="width: 100%; max-width: 150px;">
                            <i class="fas fa-question-circle suggestion-icon" data-tooltip="{{{damageTooltip}}}"></i>
                            <input type="text" class="override-input" data-field="damageFormula" value="{{previewStats.mainDamageFormula}}" style="text-align: right; width: 100%;">
                        </div>
                    </div>
                    <div class="stat-block">{{{previewStats.damage}}}</div>
                </div>

                {{#if previewStats.halvedDamage}}
                <div class="stat-group">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="stat-label">Halved Damage (Horde)</span>
                        <!-- REPLACED: Select with Input Group -->
                        <div class="feature-input-group" style="width: 100%; max-width: 150px;">
                            <i class="fas fa-question-circle suggestion-icon" data-tooltip="{{{halvedDamageTooltip}}}"></i>
                            <input type="text" class="override-input" data-field="halvedDamageFormula" value="{{previewStats.mainHalvedDamageFormula}}" style="text-align: right; width: 100%;">
                        </div>
                    </div>
                    <div class="stat-block">{{{previewStats.halvedDamage}}}</div>
                </div>
                {{/if}}

                <!-- FEATURES SECTION -->
                <div class="features-preview-section">
                    <h4 class="features-header">Feature Changes</h4>
                    {{#if featurePreviewData.length}}
                        <div class="feature-changes-list">
                            {{#each featurePreviewData}}
                                <div class="feature-change-row">
                                    <div class="feature-label">
                                        {{{this.originalName}}} <i class="fas fa-arrow-right" style="font-size: 0.8em; opacity: 0.5; margin: 0 5px;"></i>
                                    </div>
                                    
                                    <div class="feature-control">
                                        {{#if this.options}}
                                            <!-- Combobox for damage features -->
                                            <div class="feature-input-group">
                                                <i class="fas fa-question-circle suggestion-icon" data-tooltip="{{{this.optionsTooltip}}}"></i>
                                                <input type="text" class="feature-override-input feature-damage-input" data-itemid="{{this.itemId}}" value="{{this.newName}}">
                                            </div>
                                        {{else if this.isMinionFeature}}
                                            <!-- SPECIAL: Minion Numeric Input -->
                                            <div class="minion-group" style="display:flex; align-items:center; gap:2px; font-weight:bold; color:#ea80fc;">
                                                Minion ( <input type="number" class="minion-val-input" data-itemid="{{this.itemId}}" value="{{this.minionValue}}"> )
                                            </div>
                                        {{else}}
                                            <!-- Fallback to text input if renamed or static text -->
                                            {{#if this.isRenamed}}
                                                <input type="text" class="feature-override-input" data-itemid="{{this.itemId}}" value="{{this.newName}}" title="Rename Feature">
                                            {{else}}
                                                <div class="feature-new-static">{{this.newName}}</div>
                                            {{/if}}
                                        {{/if}}
                                    </div>
                                </div>
                            {{/each}}
                        </div>
                    {{else}}
                        <div class="no-changes">No modified features.</div>
                    {{/if}}
                </div>

                <!-- NEW FEATURES SECTION (CHECKBOXES) -->
                {{#if allSuggestedFeatures.length}}
                <div class="features-preview-section">
                    <h4 class="features-header" style="color: #98fb98;">New Suggested Features</h4>
                    <div class="feature-changes-list">
                        {{#each allSuggestedFeatures}}
                            <div class="feature-change-row new-feature-row">
                                <label class="feature-label" style="cursor: pointer; display: flex; align-items: center; width: 100%;">
                                    <input type="checkbox" class="feature-checkbox" data-feature="{{this.name}}" {{#if this.checked}}checked{{/if}} style="margin-right: 8px;">
                                    <strong style="color: #eee;">{{this.name}}</strong>
                                </label>
                            </div>
                        {{/each}}
                    </div>
                </div>
                {{/if}}
                
                <div class="preview-note">
                    <i class="fas fa-info-circle"></i> Edit values to override random rolls.
                </div>
            {{/if}}
        </div>

    </div>

    <!-- Footer Action -->
    <footer class="sheet-footer">
        <button type="button" data-action="applyChanges" class="apply-btn">
            {{#if (eq linkData null)}}
                <i class="fas fa-file-import"></i> Import & Apply Tier {{previewStats.tier}}
            {{else}}
                <i class="fas fa-bolt"></i> Apply Tier {{previewStats.tier}} to {{actorName}}
            {{/if}}
        </button>
    </footer>

    {{else}}
    <div class="empty-state">
        <i class="fas fa-skull" style="font-size: 4em; opacity: 0.3; margin-bottom: 20px;"></i>
        <p>Select an Adversary from the list above to begin preview.</p>
    </div>
    {{/if}}

</div>