<div class="dh-adv-manager-content encounter-builder">
    
    <div class="eb-layout">
        
        <!-- LEFT COLUMN: Library -->
        <div class="eb-column eb-column-library">
            
            <div class="eb-controls">
                <!-- Search -->
                <div class="eb-search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="eb-search-input" placeholder="Search adversaries..." value="{{searchQuery}}">
                    {{#if searchQuery}}
                    <button type="button" data-action="clearSearch" class="clear-btn"><i class="fas fa-times"></i></button>
                    {{/if}}
                </div>

                <!-- Filters -->
                <div class="eb-filters-row">
                    <!-- Source Selector -->
                    <div class="select-wrapper eb-source-wrapper">
                        <select name="filterSource" class="eb-source-select">
                            {{#each sourceOptions}}
                            <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                            {{/each}}
                        </select>
                        <i class="fas fa-database select-arrow"></i>
                    </div>

                    <!-- Type Selector -->
                    <div class="select-wrapper eb-type-wrapper">
                        <select name="filterType" class="eb-type-select">
                            {{#each typeOptions}}
                            <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                            {{/each}}
                        </select>
                        <i class="fas fa-paw select-arrow"></i>
                    </div>

                    <!-- Tier Buttons -->
                    <div class="eb-tier-buttons">
                        {{#each tiers}}
                        <button type="button" class="tier-tab-btn {{this.cssClass}}" data-action="selectTier" data-tier="{{this.value}}">
                            {{this.label}}
                        </button>
                        {{/each}}
                    </div>
                </div>
            </div>

            <div class="eb-results-header">
                Library ({{resultCount}})
            </div>

            <div class="eb-results-list">
                {{#each adversaries}}
                <div class="eb-adversary-row" data-uuid="{{this.uuid}}" data-action="openSheet">
                    
                    <div class="eb-row-actions-left">
                        <!-- Add Button -->
                        <button type="button" class="eb-add-btn" data-action="addUnit" title="Add to Encounter">
                            <i class="fas fa-plus"></i>
                        </button>

                        <!-- Edit Button -->
                        <button type="button" class="eb-edit-btn" data-action="editAdversary" title="Edit in Live Manager">
                            <i class="fas fa-sliders-h"></i>
                        </button>
                    </div>

                    <div class="eb-row-main">
                        <img src="{{this.img}}" class="eb-row-img" alt="{{this.name}}">
                        <div class="eb-row-info">
                            <div class="eb-row-name">{{this.name}}</div>
                            <div class="eb-row-meta">
                                <span class="eb-type-tag">{{this.type}}</span>
                                {{#if this.isCompendium}}
                                <i class="fas fa-book eb-compendium-icon" title="Compendium"></i>
                                {{/if}}
                                <span class="badge-tier small" style="margin-left:5px;">T{{this.tier}}</span>
                                
                                <!-- NEW: Special Features Display (Left) -->
                                {{#each this.specialFeatures}}
                                    <span class="feature-tag">{{this}}</span>
                                {{/each}}
                            </div>
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="empty-state">
                    <p>No adversaries found.</p>
                </div>
                {{/each}}
            </div>
        </div>

        <!-- RIGHT COLUMN: Encounter Settings & List -->
        <div class="eb-column eb-column-encounter">
            
            <!-- PC Configuration -->
            <div class="eb-settings-panel">
                <!-- Grouped Row: PC, Tier (moved left), Fear (moved right) -->
                <div class="eb-settings-row-group">
                    <div class="eb-setting-col pc-col">
                        <label># PCs:</label>
                        <div class="select-wrapper mini">
                            <select class="pc-count-select">
                                {{#each pcCountOptions}}
                                <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Moved Tier to Left -->
                    <div class="eb-setting-col tier-col">
                        <label>Party Tier:</label>
                        <div class="select-wrapper mini">
                            <select class="pc-tier-select">
                                {{#each pcTierOptions}}
                                <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>

                    <!-- Moved Fear to Right -->
                    <div class="eb-setting-col fear-col">
                        <label title="Spending more Fear increases the perceived difficulty level.">
                            Fear Budget: <i class="fas fa-question-circle" style="font-size:0.8em; color:#888;"></i>
                        </label>
                        <div class="select-wrapper mini">
                            <select class="pc-fear-select">
                                {{#each fearOptions}}
                                <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BP Header + Synergy Grid Wrapper -->
            <div class="eb-header-row">
                <!-- BP Calculation Header (High Contrast) -->
                <div class="eb-bp-header">
                    <div class="bp-stat">
                        <span class="bp-label">Budget Limit</span>
                        <span class="bp-value">{{bpData.total}}</span>
                        <div class="bp-sub-badge">Base: {{bpData.base}}</div>
                    </div>
                    
                    <!-- Dynamic Skull Image -->
                    <div class="bp-skull-container">
                        <img src="{{bpData.skullImage}}" class="bp-skull-img" alt="Difficulty Skull">
                    </div>

                    <div class="bp-stat">
                        <span class="bp-label">Current Cost</span>
                        <span class="bp-value cost-{{bpData.statusColor}}">{{bpData.cost}}</span>
                        <div class="bp-difficulty {{bpData.difficultyClass}}">{{bpData.difficultyLabel}}</div>
                    </div>
                </div>

                <!-- Synergy/Feature Icons Grid (20% Width) -->
                <div class="eb-synergy-grid">
                    <div class="synergy-item {{#if synergy.summoner}}active{{/if}}" data-tooltip="There are adversaries capable of summoning other adversaries.">
                        <img src="icons/environment/people/charge.webp" class="synergy-icon">
                    </div>
                    <div class="synergy-item {{#if synergy.spotlighter}}active{{/if}}" data-tooltip="There are adversaries capable of spotlighting other adversaries.">
                        <img src="icons/skills/movement/arrows-up-trio-red.webp" class="synergy-icon">
                    </div>
                    <div class="synergy-item {{#if synergy.momentum}}active{{/if}}" data-tooltip="There are adversaries capable of gaining Fear when they succeed on an attack.">
                        <img src="icons/skills/melee/strike-weapons-orange.webp" class="synergy-icon">
                    </div>
                    <div class="synergy-item {{#if synergy.relentless}}active{{/if}}" data-tooltip="There are adversaries that can be spotlighted multiple times per GM turn.">
                        <img src="icons/magic/unholy/silhouette-evil-horned-giant.webp" class="synergy-icon">
                    </div>
                </div>
            </div>

            <!-- Modifiers List (Grid 2 Cols) -->
            <div class="eb-modifiers-list">
                {{#each bpData.modifiers}}
                <div class="eb-modifier-row {{#if this.active}}active{{/if}} {{#if this.disabled}}disabled{{/if}}" 
                     {{#if this.manual}}data-action="toggleModifier" data-key="{{this.key}}"{{/if}}>
                    
                    <div class="mod-check">
                        {{#if this.active}}<i class="fas fa-check-square"></i>
                        {{else}}<i class="fas fa-square"></i>{{/if}}
                    </div>
                    <div class="mod-info">
                        <span class="mod-label">{{this.label}}</span>
                        <span class="mod-val">{{this.val}}</span>
                    </div>
                </div>
                {{/each}}
            </div>

            <!-- Encounter Units List -->
            <div class="eb-encounter-list-wrapper">
                <div class="eb-results-header">Adversaries</div>
                <div class="eb-encounter-list">
                    {{#each encounterList}}
                    <div class="eb-encounter-item" draggable="true" data-uuid="{{this.uuid}}" data-entryid="{{this.entryId}}" data-action="openSheet">
                        
                        <div class="eb-row-main">
                            <img src="{{this.img}}" class="eb-row-img small" alt="{{this.name}}">
                            <div class="eb-row-info">
                                <div class="eb-row-name">{{this.name}}</div>
                                <div class="eb-row-meta">
                                    <span class="eb-type-tag" style="font-size: 0.75em;">{{this.type}}</span>
                                    <span class="badge-tier small">T{{this.tier}}</span>
                                    
                                    <!-- Special Features Display (Right) -->
                                    {{#each this.specialFeatures}}
                                        <span class="feature-tag">{{this}}</span>
                                    {{/each}}
                                </div>
                            </div>
                        </div>
                        
                        <div class="eb-item-actions">
                            <!-- Damage Boost Button -->
                            <button type="button" 
                                    class="unit-boost-btn {{#if this.hasDamageBoost}}active{{/if}}" 
                                    data-action="toggleUnitBoost" 
                                    title="{{this.damageBoostTooltip}}">
                                <i class="fas fa-fire"></i>
                            </button>

                            <button type="button" class="eb-remove-btn" data-action="removeUnit" data-entryid="{{this.entryId}}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {{else}}
                    <div class="empty-state small">
                        <p>Add units from the library.</p>
                    </div>
                    {{/each}}
                </div>
            </div>

            <!-- Create Button Footer -->
            <div class="eb-action-footer">
                <button type="button" class="eb-create-btn" data-action="createEncounter">
                    <i class="fas fa-folder-plus"></i> Create Encounter
                </button>
                
                <button type="button" class="eb-place-btn" data-action="placeEncounter" title="Create & Place Invisible">
                    <i class="fas fa-street-view"></i>
                </button>
            </div>

        </div>

    </div>

</div>